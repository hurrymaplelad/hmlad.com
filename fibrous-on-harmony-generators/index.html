<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Fibrous on Harmony Generators? Impossible</title><meta name="author" content="Adam Hull" /><link rel="canonical" href="http://bites.goodeggs.com/posts/fibrous-on-harmony-generators/" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="Fibrous on Harmony Generators? Impossible" /><meta property="og:description" content="瀼䄾朠潯⁤牆摩祡愠瑦牥潮湯挠慨⁴扡畯⁴獡湹档潲潮獵瀠潲牧浡業杮洠摯汥⁳敬瑦洠⁥潷摮牥湩⁧晩琠敨映扩潲獵䄠䥐挠畯摬戠⁥浩汰浥湥整⁤湯琠灯漠⁦愼栠敲㵦栢瑴㩰⼯楷楫攮浣獡牣灩⹴牯⽧潤畫瀮灨椿㵤慨浲湯㩹敧敮慲潴獲㸢卅‶敧敮慲潴獲⼼㹡‮敇敮慲潴獲愠敲戠歡摥椠⁮潴丠摯⁥⸰ㄱ‬桃潲敭ㄠⰹ愠摮䘠物晥硯‮䄠瀠牯⁴潷汵⁤敢愠戠杩戠潯瑳琠⁯湩整潲数慲楢楬祴‮㰠⁡牨晥∽瑨灴㩳⼯楧桴扵挮浯术潯汧⽥牴捡略⵲潣灭汩牥㸢牔捡略㱲愯‾慣⁮癥湥琠慲獮潦浲朠湥牥瑡牯戠獡摥挠摯⁥湩潴愠㰠⁡牨晥∽瑨灴⼺琯慲散牵挭浯楰敬⹲潧杯敬潣敤挮浯术瑩搯浥⽯敲汰栮浴⍬畦据楴湯┪〲整瑳㈥⠰┩〲㜥╂䄰㈥┰〲楹汥╤〲┱䈳〥╁〲㈥瘰牡㈥愰㈥┰䐳㈥礰敩摬㈥㈰㌥╂䄰㈥┰〲牴╹〲㜥╂䄰㈥┰〲㈥┰〲楹汥╤〲╡䈳〥╁〲㈥┰䐷㈥挰瑡档㈥⠰⥥㈥┰䈷〥╁〲㈥┰〲㈥礰敩摬㈥㤰┹䈳〥╁〲㈥┰䐷〥╁〲㈥昰牯瘨牡㈥椰㈥┰䐳┰䈳㈥椰㈥┰䌳㈥㄰㌥╂〲╩䈲㈥⥂㈥┰䈷〥╁〲㈥┰〲㈥礰敩摬㈥㄰㌲㌥╂䄰㈥┰〲㜥╄䄰㜥╄䄰〥晁湵瑣潩╮〲潮浲污⤨㈥┰䈷〥╁〲㈥瘰牡㈥愰㈥┰䐳㈥戰㌥╂䄰㈥┰〲敲畴湲㈥戰㌥╂䄰㜥≄朾慩瑮猠慴整洠捡楨敮⼼㹡琠慨⁴畲獮漠⁮污⁬景琠摯祡⌦㤳猻攠癮物湯敭瑮⹳⼼㹰㰊㹰瑁映物瑳琠敨瀠牯⁴潬歯摥瀠潲業楳杮‮楗楫数楤⁡汣楡敭⁤桴瑡朠湥牥污挠牯畯楴敮⁳潣汵⁤敢㰠⁡牨晥∽瑨灴⼺支⹮楷楫数楤⹡牯⽧楷楫䌯牯畯楴敮䌣浯慰楲潳彮楷桴束湥牥瑡牯≳戾極瑬漠⁮敧敮慲潴獲⼼㹡‬湡⁤慭祮映汯獫栠癡⁥愼栠敲㵦栢瑴㩰⼯慴歳獪漮杲∯搾湯㱥愯‾愼栠敲㵦栢瑴獰⼺术獩⹴楧桴扵挮浯振敲瑡潩楮⽸㜵㈶㌸∷樾獵㱴愯‾愼栠敲㵦栢瑴獰⼺术獩⹴楧桴扵挮浯䈯湥楶⽥㘵㜶㔵∷琾慨㱴愯⸾†晁整⁲⁡楬瑴敬渠潯汤湩⁧♉㌣㬹⁭牰瑥祴猠牵⁥瑩挠湡⌦㤳琻戠⁥潤敮‮䤠⁮⁡慈浲湯⁹湥楶潲浮湥⁴⁡畦据楴湯挠湡漠汮⁹畳灳湥⁤硥捥瑵潩⁮瑡㰠潣敤社敩摬⼼潣敤‾硥牰獥楳湯⁳湡⁤挼摯㹥楹汥㱤振摯㹥攠灸敲獳潩獮挠湡漠汮⁹灡数牡椠⁮敧敮慲潴⁲畦据楴湯⹳䄠礠敩摬攠灸敲獳潩⁮慣湮瑯戠⁥牷灡数⁤灵戠桥湩⁤⁡楦牢畯⁳挼摯㹥祳据⼼潣敤‾牯㰠潣敤眾楡㱴振摯㹥㰮瀯" /><meta property="og:site_name" content="HurryMapleLad" /><meta property="og:url" content="http://hurrymaplelad.com/fibrous-on-harmony-generators/" /><link rel="icon" type="image/png" href="/favicon.png" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="HurryMapleLad" type="application/rss+xml" href="/rss.xml" /><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-35976996-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body><header><h1><a href="/">Hurry <br>Maple <br> Lad</a></h1></header><div id="main"><div id="content"><div><article class="hentry" role="article"><header><h1 class="entry-title">Fibrous on Harmony Generators? Impossible</h1><p class="meta"><time datetime="2013-08-17T19:00:00.000Z">August 17th, 2013</time></p><p class="meta canonical"><a href="http://bites.goodeggs.com/posts/fibrous-on-harmony-generators/" target="_blank">Crossposted from bites.goodeggs.com</a></p></header><div class="entry-content undefined"><p>A good Friday afternoon chat about asynchronous programming models left me wondering if the fibrous API could be implemented on top of <a href="http://wiki.ecmascript.org/doku.php?id=harmony:generators">ES6 generators</a>. Generators are baked in to Node 0.11, Chrome 19, and Firefox.  A port would be a big boost to interoperability.  <a href="https://github.com/google/traceur-compiler">Traceur</a> can even transform generator based code into a <a href="http://traceur-compiler.googlecode.com/git/demo/repl.html#function*%20test%20()%20%7B%0A%20%20yield%201%3B%0A%20%20var%20a%20%3D%20yield%202%3B%0A%20%20try%20%7B%0A%20%20%20%20yield%20a%3B%0A%20%20%7D%20catch%20(e)%20%7B%0A%20%20%20%20yield%2099%3B%0A%20%20%7D%0A%20%20for(var%20i%20%3D0%3B%20i%20%3C%201%3B%20i%2B%2B)%20%7B%0A%20%20%20%20yield%20123%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20normal()%20%7B%0A%20%20var%20a%20%3D%20b%3B%0A%20%20return%20b%3B%0A%7D">giant state machine</a> that runs on all of today&#39;s environments.</p>
<p>At first the port looked promising. Wikipedia claimed that general coroutines could be <a href="http://en.wikipedia.org/wiki/Coroutine#Comparison_with_generators">built on generators</a>, and many folks have <a href="http://taskjs.org/">done</a> <a href="https://gist.github.com/creationix/5762837">just</a> <a href="https://gist.github.com/Benvie/5667557">that</a>.  After a little noodling I&#39;m pretty sure it can&#39;t be done.  In a Harmony environment a function can only suspend execution at <code>yield</code> expressions and <code>yield</code> expressions can only appear in generator functions. A yield expression cannot be wrapped up behind a fibrous <code>sync</code> or <code>wait</code>.</p>
<!-- more -->

<p>Let&#39;s say we&#39;ve got a fibrous function <code>f</code> that synchronously calls asychronous function <code>g</code>:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> g = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
  setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'g done'</span>);
    callback();
  }, <span class="hljs-number">1000</span>);
};

<span class="hljs-keyword">var</span> f = fibrous(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  g.sync();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'f done'</span>);
};</code></pre>

<p>When we call <code>f</code> we wait one second, log <code>&#39;g done&#39;</code>, then log <code>&#39;f done&#39;</code>.  We need to halt <code>f</code> before the <code>console.log</code>, but <code>f</code> has no yield expressions.  It cannot be halted with any combination of ES6 generators.  Tough break.</p>
<hr>
<h3 id="related">Related</h3>
<ul>
<li><a href="http://taskjs.org/">Task.js</a> seems like a great way to get fibrous-like behavior within the generator constraints.  Still waiting on <a href="https://github.com/mozilla/task.js/issues/28">ES6 syntax support</a> and a <a href="https://github.com/mozilla/task.js/issues/17">CommonJS module published to NPM</a>.</li>
<li>Fellow coffee lovers, the proposed <a href="https://github.com/jashkenas/coffee-script/pull/3078">coffee script syntax for generators</a> is a &#39;lil fugly and worth checking out.</li>
</ul>
</div><footer><p class="meta"><a class="basic-alignment left" href="/ids-in-mongoose-json-and-backbone/">&laquo; Ids in Mongoose, JSON, and Backbone</a><a class="basic-alignment right" href="/pg-and-the-epicureans/">PG and the Epicureans &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bites.goodeggs.com/posts/fibrous-on-harmony-generators/'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><p>by Adam Hull<a class="linkedin icon" href="http://www.linkedin.com/in/hurrymaplelad" target="_blank"></a><a class="goodreads icon" href="http://www.goodreads.com/hurrymaplelad" target="_blank"></a><a class="stackoverflow icon" href="http://stackoverflow.com/users/407845/hurrymaplelad" target="_blank"></a><a class="github icon" href="https://github.com/hurrymaplelad" target="_blank"></a></p></footer></body></html>