<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Loading Scripts in the Critical Path: A Commerce Case Study</title><meta name="author" content="Adam Hull" /><link rel="canonical" href="http://bites.goodeggs.com/posts/mobile-page-load/" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="Loading Scripts in the Critical Path: A Commerce Case Study" /><meta property="og:description" content=" Starting javascript on DOMContentLoaded, a pattern  baked into  or  recommended by  many frameworks, defers some work that could be done earlier.  There aren't many examples of what can be done early, or how to wire it up.  Here's how we did it on the Good Eggs mobile site.
" /><meta property="og:site_name" content="HurryMapleLad" /><meta property="og:url" content="http://hurrymaplelad.com/mobile-page-load/" /><link rel="icon" type="image/png" href="/favicon.png" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="HurryMapleLad" type="application/rss+xml" href="/rss.xml" /><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-35976996-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body><header><h1><a href="/">Hurry <br>Maple <br> Lad</a></h1></header><div id="main"><div id="content"><div><article class="hentry" role="article"><style scoped="scoped">img {
  max-width: 90%;
}
.right {
  float: right;
  margin-left: 1.5em;
}
.center {
  text-align: center;
  margin-bottom: 1em;
}
.clear {
  clear: both;
}
</style><header><h1 class="entry-title">Loading Scripts in the Critical Path: A Commerce Case Study</h1><p class="meta"><time datetime="2014-06-16T00:00:00.000Z">June 16th, 2014</time></p><p class="meta canonical"><a href="http://bites.goodeggs.com/posts/mobile-page-load/" target="_blank">Crossposted from bites.goodeggs.com</a></p></header><div class="entry-content mobile-page-load"><p>Starting javascript on DOMContentLoaded, a pattern <a href="https://docs.angularjs.org/guide/bootstrap">baked into</a> or <a href="http://backbonejs.org/docs/todos.html#section-2">recommended by</a> many frameworks, defers some work that could be done earlier.  There aren&#39;t many examples of what can be done early, or how to wire it up.  Here&#39;s how we did it on the Good Eggs mobile site.
<!-- more --></p>
<h2 id="the-problem">The Problem</h2>
<p>DOMContentLoaded is the start of life for most Javascript apps. It&#39;s a browser event signalling HTML has been fully parsed, and javascript can do <a href="http://blogs.msdn.com/b/ie/archive/2008/04/23/what-happened-to-operation-aborted.aspx">its worst</a>. Frameworks like Angular wait by default for this event before starting up. Usually, our app must start up before a visitor can accomplish whatever it is they came for.  We need to wire up event listeners.  We might even need to generate DOM elements by rendering templates. DOMContentLoaded quickly becomes a bottleneck in our <a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/measure-crp">critical rendering path</a>.  Phones, with their high-latency networks, exacerbate the problem.  An extra request for javascript can <a href="http://calendar.perfplanet.com/2011/carrier-networks-down-the-rabbit-hole/">add hundreds of milliseconds</a>.</p>
<p>While this bottleneck is fairly <a href="https://groups.google.com/forum/#!topic/closure-library-discuss/G-7Ltdavy0E">widely</a> <a href="https://alexsexton.com/blog/2010/01/dont-let-document-ready-slow-you-down/">known</a>, and most frameworks provide hooks for motivated developers to work around it, examples of starting up rich browser apps early are sparse. The Good Eggs engineering team, unconvinced that the heavy-backbone client-rendered approach of our desktop site could deliver a satisfying mobile experience, explored early start up.</p>
<h2 id="our-approach">Our Approach</h2>
<div class="right">
<img src="/images/mobile-page-load/complete-page.jpg" alt="finished page">
</div>

<p>We&#39;ll step through loading a page selling blueberries as an example.  It&#39;s a good candidate for page load optimization because it&#39;s high traffic, and much of the value of the page doesn&#39;t depend on the interactive elements. Visitors land on this page to learn more about blueberries, things like &quot;Who grew them?&quot;, or &quot;Were they grown with pesticides?&quot;.  If they like what they find they may decide to buy, but we can build out the shopping widgets in a few hundred milliseconds while they learn.  We&#39;re not reducing the functionality of the page, or the total work it takes to set up, just moving some of it out of the critical path.</p>
<p>Hoping to add minimal complexity, we split the single event, DOMContentLoaded, into the three that benefitted us most:</p>
<ol>
<li><a href="#page-dom-loaded">Page DOM Loaded</a> - The interesting bits of HTML markup have loaded</li>
<li><a href="#page-js-loaded">Page JS Loaded</a> - Page specific, user-independent functionality has loaded</li>
<li><a href="#session-loaded">Session Loaded</a> - User-specific functionality and data has loaded</li>
</ol>
<div class="clear"></div>

<p>Loading the page on an iPhone 5 over a 3G network reveals this timeline:</p>
<p><img src="/images/mobile-page-load/timeline.jpg" alt="timeline"></p>
<p>Note that all three of these events occur on this page before <a href="https://developer.mozilla.org/en-US/docs/Web/Reference/Events/DOMContentLoaded">DOMContentLoaded</a>, the traditional launchpoint for single page js apps.  We&#39;re piggybacking on the browser&#39;s <a href="http://en.wikipedia.org/wiki/Incremental_rendering">incremental rendering</a> to wire up javascript before the DOM has fully finished loading.</p>
<pre class="highlight"><code class="xml"><span class="tag">&lt;<span class="title">body</span>&gt;</span>
  <span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- Page DOM ... --&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>
  <span class="comment">&lt;!-- 1. Page DOM Loaded --&gt;</span>
  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"//cdn.example.com/page.{{hash}}.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
  <span class="comment">&lt;!-- 2. Page JS Loaded --&gt;</span>
  <span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">startPage({<span class="comment">/* user-agnostic data */</span>})</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/session.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
  <span class="comment">&lt;!-- 3. Session JS Loaded --&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="comment">&lt;!-- DOMContentLoaded --&gt;</span></code></pre>
<p>What can we do at these points? We&#39;ll explore each in detail below.</p>
<h2 id="page-dom-loaded">Page DOM Loaded</h2>
<div class="right">
<img src="/images/mobile-page-load/page-dom-loaded.jpg" alt="page dom loaded">
</div>

<p>At this point, we&#39;ve loaded the markup that makes this page useful: the name and size of the blueberries a (cached) photo, a link to the shopper&#39;s basket and more.</p>
<p>The link to the basket and the link back to previous page are vanilla <code>&lt;a&gt;</code> tags, so the visitor can click them now before any javascript has loaded.  The hamburger menu icon won&#39;t actaully open the menu until the Page JS Loaded hook.  We could hide it until js has loaded but the flickering drew unwanted attention to that corner of the screen.</p>
<p>Note that that basket icon, while clickable, doesn&#39;t yet have the count of items in the basket.  That user-specific count comes in with the session.</p>
<p>By building the page with this stage of the lifecycle in mind, and pre-rendering on the server, we show information about the blueberries a full second before DOMContentLoaded.  If the user is just browsing (not shopping), this is the end of their critical path.</p>
<div class="clear"></div>

<h2 id="page-js-loaded">Page JS Loaded</h2>
<div class="right">
<img src="/images/mobile-page-load/page-js-loaded.jpg" alt="page js loaded">
</div>

<p>At this point, all the javascript powering interactions on this page has loaded and executed. The hamburger menu is now interactive, even though we still don&#39;t know how many items are in the user&#39;s basket.</p>
<p>Although we&#39;ve wired up event listeners for the &quot;Add to Basket&quot; button and quantity toggle (saving future script execution cycles), we keep the button hidden until we know if the user already has some of these blueberries in their basket so we can message appropriately.</p>
<div class="clear"></div>

<h2 id="session-loaded">Session Loaded</h2>
<div class="right">
<img src="/images/mobile-page-load/all-js-loaded.jpg" alt="finished page">
</div>

<p>At this point, we&#39;ve got user-specific data like the contents of their basket.  We can finally fill in that pesky item count in the top right, and show the &quot;Add to Basket&quot; button.</p>
<p>Why is this a big enough win to merit one of three lifecycle events? Caching.</p>
<p>Fastly can deliver our js bundle cached from its CDN in less time than it takes our server to send a little user-specific session information.  The screenshot below shows the case with the largest gap, where cachable scripts are already cached on the phone (note the 304 response) and only the session requires a network request.  This is the load sequence we expect for visitors browsing around the site, looking at all the wild vegetables availing only in the spring.</p>
<div class="clear"></div>

<p><img src="/images/mobile-page-load/network.jpg" alt="network"></p>
<p>For visitors who came to shop (rather than ogle), the &quot;Add to Basket&quot; button is in the critical path. They can&#39;t leave this page with the blueberries they came for until they click that button. We wait for session information to load before showing the button so shoppers can see how many, if any, blueberries they&#39;re already getting.</p>
<p>The session request is often the slowest for this user flow. We want to start it as early as possible, so we load it with a script tag. Firing off an XmlHttpRequest from the page js would be more convenient for developers (we&#39;d get a sucess callback to wire into), but doing so would delay starting the session request until after the page script had loaded and executed, potentially several hundred millis.  Instead we place a script tag just below the page js script tag in the body:</p>
<pre class="highlight"><code class="xml"><span class="tag">&lt;<span class="title">body</span>&gt;</span>
  <span class="tag">&lt;<span class="title">div</span>&gt;</span><span class="comment">&lt;!-- Page DOM ... --&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span>
  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"//cdn.example.com/page.{{hash}}.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
  <span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript">startPage(<span class="comment">/*...*/</span>)</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
  <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"/session.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span></code></pre>
<p>With this arrangement, modern browsers will download both scripts in parallel, and execute them in the order they appear in the DOM. The page script can listen for the session script to finish, fill in the user details, and complete our page.</p>
<h2 id="next-steps">Next Steps</h2>
<p>There are still major oppourtunities to optimize our critical path.</p>
<p>Currently, to keep the build process simple, we inline all the styles for the whole site in the head of every page. This should be trimmed down to only the styles used on the page, and ideally on the styles for the above-the-fold content.</p>
<div class="right">
<img src="/images/mobile-page-load/incremental.jpg" alt="incremental rendering">
</div>

<p>We should optimize the order of the elements in the page DOM, so the most interesting are incrementally rendered first.  Currently the DOM order mirrors vertical order on the page, loading the navigation first.</p>
<p>For maximum performance, all the HTML and CSS to render the above-the-fold content should <a href="http://calendar.perfplanet.com/2012/make-your-mobile-pages-render-in-under-one-second/">come in the first 15kB</a> (compressed).</p>
<div class="clear"></div>

<p>We&#39;re hoping these three page load hooks give us the flexibility to tune mobile and responsive web perfomance moving forward.  If you&#39;ve tried a different approach to optimizing the DOMContentLoaded bottleneck, we&#39;d love to hear about it!</p>
</div><footer><p class="meta"><a class="basic-alignment left" href="/a-better-food-system-phone-sized/">&laquo; A Better Food System, Phone Sized</a><a class="basic-alignment right" href="/speed-up-your-responsive-app-with-node-and-varnish/">Speed up your Responsive App with Node and Varnish &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bites.goodeggs.com/posts/mobile-page-load/'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><p>by Adam Hull<a class="linkedin icon" href="http://www.linkedin.com/in/hurrymaplelad" target="_blank"></a><a class="goodreads icon" href="http://www.goodreads.com/hurrymaplelad" target="_blank"></a><a class="stackoverflow icon" href="http://stackoverflow.com/users/407845/hurrymaplelad" target="_blank"></a><a class="github icon" href="https://github.com/hurrymaplelad" target="_blank"></a></p></footer></body></html>