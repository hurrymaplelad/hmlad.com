<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>How to Remove a Property from a Mongoose.js Schema</title><meta name="author" content="Adam Hull" /><link rel="canonical" href="http://bites.goodeggs.com/post/36553128854/how-to-remove-a-property-from-a-mongoosejs-schema" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta property="og:title" content="How to Remove a Property from a Mongoose.js Schema" /><meta property="og:description" content="瀼吾楨⁳桳畯摬戠⁥楳灭敬‬畢⁴潍杮潯敳爠慥汬⁹汣湩獧琠⁯慤慴椠⁮硥獩楴杮搠捯浵湥獴‮䤠⌦㤳氻⁬慷歬琠牨畯桧愠汬琠敨眠祡⁳⁉慷瑮摥椠⁴潴眠牯⁫桴瑡映楡敬⹤†敗⌦㤳氻⁬敲潭敶愠⁮挼摯㹥牯慧楮㱣振摯㹥映慬⁧牦浯愠琠祯㰠潣敤䘾潯㱤振摯㹥洠摯汥猠⁯敷挠湡爠灥慬散椠⁴楷桴㰠⁡牨晥∽瑨灴⼺眯睷渮瑹浩獥挮浯㈯㄰⼲〱ㄯ⼴灯湩潩⽮畳摮祡戯瑩浴湡洭⵹牤慥⵭潦摯氭扡汥栮浴≬䈾瑩浴湡⌦㤳猻搠敲浡氠扡汥⼼㹡‮䤠⁦潹⁵番瑳挠浡⁥潦⁲桴⁥潳畬楴湯‬⁉牡楲敶⁤瑡㰺瀯ਾ瀼敲㰾潣敤挠慬獳∽獪㸢潆摯挮汯敬瑣潩⹮灵慤整笨ⱽ 笠甤獮瑥›潻杲湡捩›猼慰⁮汣獡㵳栢橬⵳楬整慲≬琾畲㱥猯慰㹮絽ਬ†浻汵楴›猼慰⁮汣獡㵳栢橬⵳楬整慲≬琾畲㱥猯慰㹮‬慳敦›猼慰⁮汣獡㵳栢橬⵳楬整慲≬琾畲㱥猯慰㹮੽㬩⼼潣敤㰾瀯敲ਾ㰊㹰" /><meta property="og:site_name" content="HurryMapleLad" /><meta property="og:url" content="http://hurrymaplelad.com/removing-a-property-from-a-mongoose-schema/" /><link rel="icon" type="image/png" href="/favicon.png" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="HurryMapleLad" type="application/rss+xml" href="/rss.xml" /><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-35976996-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body><header><h1><a href="/">Hurry <br>Maple <br> Lad</a></h1></header><div id="main"><div id="content"><div><article class="hentry" role="article"><header><h1 class="entry-title">How to Remove a Property from a Mongoose.js Schema</h1><p class="meta"><time datetime="2012-11-03T19:00:00.000Z">November 3rd, 2012</time></p><p class="meta canonical"><a href="http://bites.goodeggs.com/post/36553128854/how-to-remove-a-property-from-a-mongoosejs-schema" target="_blank">Crossposted from bites.goodeggs.com</a></p></header><div class="entry-content undefined"><p>This should be simple, but Mongoose really clings to data in existing documents.  I&#39;ll walk through all the ways I wanted it to work that failed.  We&#39;ll remove an <code>organic</code> flag from a toy <code>Food</code> model so we can replace it with <a href="http://www.nytimes.com/2012/10/14/opinion/sunday/bittman-my-dream-food-label.html">Bittman&#39;s dream label</a>.  If you just came for the solution, I arrived at:</p>
<pre><code class="js">Food.collection.update({},
  {$unset: {organic: <span class="hljs-literal">true</span>}},
  {multi: <span class="hljs-literal">true</span>, safe: <span class="hljs-literal">true</span>}
);</code></pre>

<p><!-- more -->Our well-loved <code>Food</code> schema might look something like:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> Food = db.model(<span class="hljs-string">'Food'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({
  name: {type: <span class="hljs-built_in">String</span>, required: <span class="hljs-literal">true</span>},
  organic: <span class="hljs-built_in">Boolean</span>
}, {
  strict: <span class="hljs-literal">true</span>
}));</code></pre>

<p>and it might be populated with documents like organic frozen broccoli:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> broccoli = <span class="hljs-keyword">new</span> Food({
  name: <span class="hljs-string">'frozen broccoli'</span>,
  organic: <span class="hljs-literal">true</span>
});</code></pre>

<p>Alright, time to get rid of that <code>organic</code> property.  Adding a property with Mongoose is as easy as declaring it in the schema.  Could removing be just as easy?</p>
<pre><code class="diff">var Food = db.model('Food', new mongoose.Schema({
    name: {type: String, required: true},
<span class="hljs-deletion">-   organic: Boolean</span>
  }, {
    strict: true
  }));</code></pre>

<p>If we reload our broccoli doc, will mongoose strip out the undeclared properties?  We did tell Mongoose to be <code>strict</code> with our <code>Food</code>…</p>
<pre><code class="js">Food.findById(broccoli, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, broccoli)</span> </span>{
  <span class="hljs-built_in">console</span>.log(broccoli.get(<span class="hljs-string">'organic'</span>));
});

&gt; <span class="hljs-literal">true</span></code></pre>

<p>No.  Too slick.  I suppose it&#39;s comforting that mongoose isn&#39;t silently manipulating our docs.  Maybe we just need to re-save <code>broccoli</code>.  Surely mongoose will be <code>strict</code> now…</p>
<pre><code class="js">broccoli.save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  Food.findById(broccoli, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, broccoli)</span> </span>{
    <span class="hljs-built_in">console</span>.log(broccoli.get(<span class="hljs-string">'organic'</span>))
  })
});

&gt; <span class="hljs-literal">true</span></code></pre>

<p>Nope.  <a href="http://grokbase.com/t/gg/mongoose-orm/123ya4qp0a/mongoose-removing-an-existing-field-from-a-collection#20120330swrofqtizat6i3kalhvfrusz5a">Mr. Heckmann rationalizes this behavior</a> as</p>
<blockquote>
<p>Mongoose &quot;plays nice&quot; with existing data in the db, not deleting it unless you tell it to.</p>
</blockquote>
<p>I&#39;ll have to be more explicit with this broccoli, more meticulous with my cleanup.  I&#39;ll unset <code>organic</code> directly.</p>
<pre><code class="js">broccoli.set(<span class="hljs-string">'organic'</span>, <span class="hljs-literal">undefined</span>);
broccoli.save(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
  Food.findById(broccoli, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, broccoli)</span> </span>{
    <span class="hljs-built_in">console</span>.log(broccoli.get(<span class="hljs-string">'organic'</span>));
  });
});

&gt; <span class="hljs-literal">true</span></code></pre>

<p>Wow.  Fine.  Now <code>strict</code> decides to help out.</p>
<p>Mongoose isn&#39;t cooperating.  Time to talk directly to Mongo.  Maybe Mongoose can at least offer me some <a href="http://mongoosejs.com/docs/api.html#model_Model-update">update sugar</a>:</p>
<pre><code class="js">Food.update({},
  {$unset: {organic: <span class="hljs-literal">true</span>}},
  {multi: <span class="hljs-literal">true</span>, safe: <span class="hljs-literal">true</span>},
  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
    Food.findById(broccoli, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, broccoli)</span> </span>{
      <span class="hljs-built_in">console</span>.log(broccoli.get(<span class="hljs-string">'organic'</span>));
    });
  }
);

&gt; <span class="hljs-literal">true</span></code></pre>

<p><img src="/images/yuno.jpg" alt="Y U NO UNSET!?"></p>
<p>This must be <code>strict</code> still <a href="https://groups.google.com/d/topic/mongoose-orm/ypvL3Fximjc/discussion">keeping us safe</a>.</p>
<p>Okay.  Last chance Mongoose.  Just give me the collection.</p>
<pre><code class="js">Food.collection.update({},
  {$unset: {organic: <span class="hljs-literal">true</span>}},
  {multi: <span class="hljs-literal">true</span>, safe: <span class="hljs-literal">true</span>},
  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> </span>{
    Food.findById(broccoli, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, brocolli)</span> </span>{
      <span class="hljs-built_in">console</span>.log(broccoli.get(<span class="hljs-string">'organic'</span>));
  }
);

&gt; <span class="hljs-literal">undefined</span></code></pre>

<p>Phew.</p>
<p>Here&#39;s a <a href="https://gist.github.com/4008255">Mocha spec</a> reproducing this frustrating sequence.  How should we make it be better?</p>
</div><footer><p class="meta"><a class="basic-alignment left" href="/rotational-grazing/">&laquo; Rotational Grazing</a><a class="basic-alignment right" href="/teacup-released/">Teacup Released &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bites.goodeggs.com/post/36553128854/how-to-remove-a-property-from-a-mongoosejs-schema'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><p>by Adam Hull<a class="linkedin icon" href="http://www.linkedin.com/in/hurrymaplelad" target="_blank"></a><a class="goodreads icon" href="http://www.goodreads.com/hurrymaplelad" target="_blank"></a><a class="stackoverflow icon" href="http://stackoverflow.com/users/407845/hurrymaplelad" target="_blank"></a><a class="github icon" href="https://github.com/hurrymaplelad" target="_blank"></a></p></footer></body></html>